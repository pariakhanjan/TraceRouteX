<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† - TraceRouteX</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <a href="dashboard.html">
                    <span class="logo-icon">ğŸŒ</span>
                    <span class="logo-text">TraceRouteX</span>
                </a>
            </div>
            <div class="nav-menu">
                <a href="dashboard.html" class="nav-link">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
                <a href="admin-users.html" class="nav-link active">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a>
                <button id="logoutBtn" class="btn btn-danger btn-sm">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-container">
        <div class="dashboard-header">
            <div>
                <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h1>
                <p class="text-muted">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…</p>
            </div>
            <button id="createUserBtn" class="btn btn-primary">
                <span>â•</span>
                Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
            </button>
        </div>

        <!-- Users Table -->
        <div class="card">
            <div class="card-header">
                <h3>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...">
                </div>
            </div>
            <div class="card-body">
                <div id="loadingUsers" class="loading-state">
                    <div class="spinner"></div>
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†...</p>
                </div>
                <div id="usersTableContainer" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø´Ù†Ø§Ø³Ù‡</th>
                                <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
                                <th>Ø§ÛŒÙ…ÛŒÙ„</th>
                                <th>Ù†Ù‚Ø´</th>
                                <th>ØªØ§Ø±ÛŒØ® Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</th>
                                <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <span class="empty-icon">ğŸ‘¥</span>
                    <h3>Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                    <p>Ù‡Ù†ÙˆØ² Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Create/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯</h2>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                
                <div class="form-group">
                    <label for="username">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ *</label>
                    <input 
                        type="text" 
                        id="username" 
                        class="form-control" 
                        required 
                        minlength="3"
                        maxlength="50"
                        placeholder="username">
                    <small class="form-text">Ø­Ø¯Ø§Ù‚Ù„ 3 Ú©Ø§Ø±Ø§Ú©ØªØ±ØŒ ÙÙ‚Ø· Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ _ </small>
                </div>

                <div class="form-group">
                    <label for="email">Ø§ÛŒÙ…ÛŒÙ„ *</label>
                    <input 
                        type="email" 
                        id="email" 
                        class="form-control" 
                        required
                        placeholder="user@example.com">
                </div>

                <div class="form-group" id="passwordGroup">
                    <label for="password">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± *</label>
                    <input 
                        type="password" 
                        id="password" 
                        class="form-control" 
                        minlength="6"
                        placeholder="Ø­Ø¯Ø§Ù‚Ù„ 6 Ú©Ø§Ø±Ø§Ú©ØªØ±">
                    <small class="form-text">Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø®Ø§Ù„ÛŒ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯ ØªØ§ Ø±Ù…Ø² ØªØºÛŒÛŒØ± Ù†Ú©Ù†Ø¯</small>
                </div>

                <div class="form-group">
                    <label for="role">Ù†Ù‚Ø´ Ú©Ø§Ø±Ø¨Ø± *</label>
                    <select id="role" class="form-control" required>
                        <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</option>
                        <option value="viewer">Viewer - Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÚ¯Ø±</option>
                        <option value="engineer">Engineer - Ù…Ù‡Ù†Ø¯Ø³</option>
                        <option value="admin">Admin - Ù…Ø¯ÛŒØ±</option>
                    </select>
                    <small class="form-text">
                        <strong>Viewer:</strong> ÙÙ‚Ø· Ù…Ø´Ø§Ù‡Ø¯Ù‡ | 
                        <strong>Engineer:</strong> Ø§ÛŒØ¬Ø§Ø¯/ÙˆÛŒØ±Ø§ÛŒØ´ Ø±Ø®Ø¯Ø§Ø¯Ù‡Ø§ | 
                        <strong>Admin:</strong> Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„
                    </small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span id="submitBtnText">Ø°Ø®ÛŒØ±Ù‡</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content modal-sm">
            <div class="modal-header">
                <h2>ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù</h2>
                <button class="modal-close" id="closeDeleteModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p>Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± <strong id="deleteUsername"></strong> Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ</p>
                <p class="text-danger">Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª!</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelDeleteBtn">Ø§Ù†ØµØ±Ø§Ù</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <span id="deleteBtnText">Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±</span>
                </button>
            </div>
        </div>
    </div>

    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/api.js"></script>
    <script>
        // State
        let allUsers = [];
        let editingUserId = null;
        let deletingUserId = null;
        let currentUser = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Check admin authentication
            currentUser = await checkAuth(['admin']);
            
            if (!currentUser) {
                window.location.href = 'login.html';
                return;
            }

            await loadUsers();
            initializeEventListeners();
        });

        // Load all users
        async function loadUsers() {
            try {
                showLoading(true);
                allUsers = await API.getUsers();
                renderUsers(allUsers);
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: ' + error.message, 'error');
                showEmptyState();
            } finally {
                showLoading(false);
            }
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (!users || users.length === 0) {
                showEmptyState();
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>
                        <strong>${escapeHtml(user.username)}</strong>
                        ${user.id === currentUser.id ? '<span class="badge badge-info">Ø´Ù…Ø§</span>' : ''}
                    </td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>
                        <span class="badge badge-${getRoleBadgeClass(user.role)}">
                            ${getRoleLabel(user.role)}
                        </span>
                    </td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button 
                                class="btn btn-sm btn-primary" 
                                onclick="openEditModal(${user.id})"
                                ${user.id === currentUser.id ? 'title="ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ø®ÙˆØ¯"' : ''}>
                                âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´
                            </button>
                            ${user.id !== currentUser.id ? `
                                <button 
                                    class="btn btn-sm btn-danger" 
                                    onclick="openDeleteModal(${user.id})">
                                    ğŸ—‘ï¸ Ø­Ø°Ù
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');

            document.getElementById('usersTableContainer').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        // Show/hide loading
        function showLoading(show) {
            document.getElementById('loadingUsers').style.display = show ? 'flex' : 'none';
            document.getElementById('usersTableContainer').style.display = show ? 'none' : 'block';
        }

        // Show empty state
        function showEmptyState() {
            document.getElementById('usersTableContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Create user button
            document.getElementById('createUserBtn').addEventListener('click', openCreateModal);

            // Modal controls
            document.getElementById('closeModalBtn').addEventListener('click', closeUserModal);
            document.getElementById('cancelBtn').addEventListener('click', closeUserModal);
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit);

            // Delete modal controls
            document.getElementById('closeDeleteModalBtn').addEventListener('click', closeDeleteModal);
            document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);
            document.getElementById('confirmDeleteBtn').addEventListener('click', handleUserDelete);

            // Search
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                logout();
                window.location.href = 'login.html';
            });

            // Close modals on outside click
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    closeUserModal();
                    closeDeleteModal();
                }
            });
        }

        // Open create modal
        function openCreateModal() {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('password').required = true;
            document.getElementById('passwordGroup').querySelector('small').style.display = 'none';
            document.getElementById('submitBtnText').textContent = 'Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±';
            document.getElementById('userModal').classList.add('active');
        }

        // Open edit modal
        async function openEditModal(userId) {
            try {
                editingUserId = userId;
                const user = allUsers.find(u => u.id === userId);
                
                if (!user) {
                    showToast('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                    return;
                }

                document.getElementById('modalTitle').textContent = 'ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ø¨Ø±';
                document.getElementById('userId').value = user.id;
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                document.getElementById('role').value = user.role;
                document.getElementById('password').value = '';
                document.getElementById('password').required = false;
                document.getElementById('passwordGroup').querySelector('small').style.display = 'block';
                document.getElementById('submitBtnText').textContent = 'Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª';
                document.getElementById('userModal').classList.add('active');
            } catch (error) {
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±', 'error');
            }
        }

        // Close user modal
        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
            document.getElementById('userForm').reset();
            editingUserId = null;
        }

        // Handle user form submit
        async function handleUserSubmit(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const originalText = submitBtnText.textContent;

            try {
                submitBtn.disabled = true;
                submitBtnText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';

                const formData = {
                    username: document.getElementById('username').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    role: document.getElementById('role').value
                };

                // Validate username (only letters, numbers, underscore)
                if (!/^[a-zA-Z0-9_]+$/.test(formData.username)) {
                    showToast('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙÙ‚Ø· Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø´Ø§Ù…Ù„ Ø­Ø±ÙˆÙ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ _ Ø¨Ø§Ø´Ø¯', 'error');
                    return;
                }

                // Add password only if provided
                const password = document.getElementById('password').value;
                if (password) {
                    if (password.length < 6) {
                        showToast('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 6 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯', 'error');
                        return;
                    }
                    formData.password = password;
                } else if (!editingUserId) {
                    showToast('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', 'error');
                    return;
                }

                if (editingUserId) {
                    // Update existing user
                    await API.updateUser(editingUserId, formData);
                    showToast('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯', 'success');
                } else {
                    // Create new user
                    await API.createUser(formData);
                    showToast('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯', 'success');
                }

                closeUserModal();
                await loadUsers();

            } catch (error) {
                console.error('Error saving user:', error);
                showToast('Ø®Ø·Ø§: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtnText.textContent = originalText;
            }
        }

        // Open delete modal
        function openDeleteModal(userId) {
            deletingUserId = userId;
            const user = allUsers.find(u => u.id === userId);
            
            if (!user) {
                showToast('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                return;
            }

            document.getElementById('deleteUsername').textContent = user.username;
            document.getElementById('deleteModal').classList.add('active');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            deletingUserId = null;
        }

        // Handle user delete
        async function handleUserDelete() {
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            const deleteBtnText = document.getElementById('deleteBtnText');
            const originalText = deleteBtnText.textContent;

            try {
                deleteBtn.disabled = true;
                deleteBtnText.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù...';

                await API.deleteUser(deletingUserId);
                showToast('Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯', 'success');
                
                closeDeleteModal();
                await loadUsers();

            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±: ' + error.message, 'error');
            } finally {
                deleteBtn.disabled = false;
                deleteBtnText.textContent = originalText;
            }
        }

        // Handle search
        function handleSearch(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderUsers(allUsers);
                return;
            }

            const filtered = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm) ||
                getRoleLabel(user.role).includes(searchTerm)
            );

            renderUsers(filtered);
        }

        // Helper: Get role badge class
        function getRoleBadgeClass(role) {
            const classes = {
                'admin': 'danger',
                'engineer': 'warning',
                'viewer': 'info'
            };
            return classes[role] || 'secondary';
        }

        // Helper: Get role label
        function getRoleLabel(role) {
            const labels = {
                'admin': 'Ù…Ø¯ÛŒØ±',
                'engineer': 'Ù…Ù‡Ù†Ø¯Ø³',
                'viewer': 'Ù…Ø´Ø§Ù‡Ø¯Ù‡â€ŒÚ¯Ø±'
            };
            return labels[role] || role;
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
