<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | TracerouteX</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
</head>
<!-- ==================== Report Incident Modal ==================== -->
<div id="reportIncidentModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>ğŸš¨ Report New Incident</h2>
            <button class="close-btn" onclick="closeReportIncidentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="reportIncidentForm">
                <div class="form-group">
                    <label for="incident-service">Service *</label>
                    <select id="incident-service" required>
                        <option value="">Select a service</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="incident-title">Title *</label>
                    <input type="text" id="incident-title" placeholder="e.g., Database Connection Issues" required>
                </div>

                <div class="form-group">
                    <label for="incident-description">Description *</label>
                    <textarea id="incident-description" rows="4" placeholder="Describe the incident in detail..." required></textarea>
                </div>

                <div class="form-group">
                    <label for="incident-severity">Severity *</label>
                    <select id="incident-severity" required>
                        <option value="low">ğŸŸ¢ Low</option>
                        <option value="medium" selected>ğŸŸ¡ Medium</option>
                        <option value="high">ğŸŸ  High</option>
                        <option value="critical">ğŸ”´ Critical</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="incident-published" checked>
                        Publish to public status page
                    </label>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeReportIncidentModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">ğŸš¨ Report Incident</button>
                </div>
            </form>
        </div>
    </div>
</div>

<body>
<!-- Navbar -->
<nav class="navbar">
    <div class="navbar-container">
        <div class="navbar-brand">
            <span class="navbar-logo">ğŸ›°ï¸</span>
            <span class="navbar-title">TracerouteX</span>
        </div>

        <div class="navbar-menu">
            <a href="dashboard.html" class="navbar-link active">
                <span>ğŸ“Š</span> Dashboard
            </a>
            <a href="public-status.html" class="navbar-link">
                <span>ğŸŒ</span> Status Page
            </a>
            <a href="admin-users.html"
               id="adminUsersLink"
               class="nav-link"
               style="display:none;">
                ğŸ‘¥ User Management
            </a>
            <div class="navbar-divider"></div>
            <div class="navbar-user">
                <span class="user-info"></span>
                <span class="user-role badge"></span>
            </div>
            <button id="logoutBtn" class="btn btn-secondary btn-sm">
                Logout
            </button>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h1 class="page-title">System Dashboard</h1>
                <p class="page-subtitle">Monitor all services and incidents in real-time</p>
            </div>

            <div class="page-actions" id="adminActions" style="display: none;">
                <button class="btn btn-primary" onclick="window.location.href='service-detail.html?action=create'">
                    <span>â•</span> Add Service
                </button>
                <button class="btn btn-danger" onclick="openReportModal()">
                    ğŸš¨ Report Incident
                </button>
                <!--                <button class="btn btn-secondary"-->
<!--                        onclick="window.location.href='incident-detail.html?id=1'">-->
<!--                    <span>ğŸš¨</span> Report Incident-->
                </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card stat-success">
                <div class="stat-icon">âœ…</div>
                <div class="stat-content">
                    <div class="stat-value" id="operationalCount">-</div>
                    <div class="stat-label">Operational</div>
                </div>
            </div>

            <div class="stat-card stat-warning">
                <div class="stat-icon">âš ï¸</div>
                <div class="stat-content">
                    <div class="stat-value" id="degradedCount">-</div>
                    <div class="stat-label">Degraded</div>
                </div>
            </div>

            <div class="stat-card stat-danger">
                <div class="stat-icon">ğŸ”´</div>
                <div class="stat-content">
                    <div class="stat-value" id="downCount">-</div>
                    <div class="stat-label">Down</div>
                </div>
            </div>

            <div class="stat-card stat-info">
                <div class="stat-icon">ğŸš¨</div>
                <div class="stat-content">
                    <div class="stat-value" id="activeIncidentsCount">-</div>
                    <div class="stat-label">Active Incidents</div>
                </div>
            </div>
        </div>

        <!-- Services Section -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Services Overview</h2>
                <div class="card-actions">
                    <select id="statusFilter" class="form-select form-select-sm">
                        <option value="">All Statuses</option>
                        <option value="up">Operational</option>
                        <option value="degraded">Degraded</option>
                        <option value="down">Down</option>
                    </select>
                </div>
            </div>

            <div id="servicesContainer">
                <!-- Services will be loaded here -->
            </div>
        </div>

        <!-- Recent Incidents -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Recent Incidents</h2>
                <div class="card-actions">
                    <select id="incidentStatusFilter" class="form-select form-select-sm">
                        <option value="">All Statuses</option>
                        <option value="open">Open</option>
                        <option value="resolved">Resolved</option>
                    </select>
                    <select id="incidentSeverityFilter" class="form-select form-select-sm">
                        <option value="">All Severities</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
            </div>

            <div id="incidentsContainer">
                <!-- Incidents will be loaded here -->
            </div>
        </div>
    </div>
</main>

<script src="../assets/js/utils.js"></script>
<script src="../assets/js/api.js"></script>
<script src="../assets/js/auth.js"></script>
<script>
    // Check authentication
    if (!Auth.requireAuth()) {
        // Redirects to login if not authenticated
    }

    let services = [];
    let incidents = [];

    document.addEventListener('DOMContentLoaded', async () => {
        const user = Auth.getUser();
        Auth.displayUserInfo();

        // Show admin actions if user is admin or engineer
        if (Auth.hasRole('admin', 'engineer')) {
            document.getElementById('adminActions').style.display = 'flex';
        }

        // Load data
        await Promise.all([
            loadServices(),
            loadIncidents()
        ]);

        // Setup event listeners
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await API.logout();
                Auth.logout();
            } catch (error) {
                Auth.logout();
            }
        });
        // ==========================================
        // ADMIN ACCESS CONTROL
        // ==========================================

        if (Auth.hasRole('admin')) {
            const adminLink = document.getElementById('adminUsersLink');
            if (adminLink) {
                adminLink.style.display = 'inline-block';
                console.log('âœ… Admin link enabled');
            }
        } else {
            console.log('â„¹ï¸ User is not admin, admin link hidden');
        }

        document.getElementById('statusFilter').addEventListener('change', renderServices);
        document.getElementById('incidentStatusFilter').addEventListener('change', renderIncidents);
        document.getElementById('incidentSeverityFilter').addEventListener('change', renderIncidents);
    });

    async function loadServices() {
        try {
            Utils.showLoading(document.getElementById('servicesContainer'));

            const response = await API.getServices();
            services = response.data.services;

            updateStats();
            renderServices();

            Utils.hideLoading();
        } catch (error) {
            Utils.hideLoading();
            Utils.showAlert('Error loading services: ' + error.message, 'error');
        }
    }

    async function loadIncidents() {
        try {
            Utils.showLoading(document.getElementById('incidentsContainer'));

            const response = await API.getIncidents();
            incidents = response.data.incidents;

            renderIncidents();

            Utils.hideLoading();
        } catch (error) {
            Utils.hideLoading();
            Utils.showAlert('Error loading incidents: ' + error.message, 'error');
        }
    }

    function updateStats() {
        const operational = services.filter(s => s.status === 'up').length;
        const degraded = services.filter(s => s.status === 'degraded').length;
        const down = services.filter(s => s.status === 'down').length;
        const activeIncidents = incidents.filter(i => i.status === 'open').length;

        document.getElementById('operationalCount').textContent = operational;
        document.getElementById('degradedCount').textContent = degraded;
        document.getElementById('downCount').textContent = down;
        document.getElementById('activeIncidentsCount').textContent = activeIncidents;
    }

    function renderServices() {
        const container = document.getElementById('servicesContainer');
        const statusFilter = document.getElementById('statusFilter').value;

        let filtered = services;
        if (statusFilter) {
            filtered = services.filter(s => s.status === statusFilter);
        }

        if (filtered.length === 0) {
            container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“¦</div>
            <div class="empty-state-text">No services found</div>
            <div class="empty-state-subtext">Start by adding your first service</div>
          </div>
        `;
            return;
        }

        container.innerHTML = `
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Service Name</th>
                <th>Description</th>
                <th>Status</th>
                <th>Last Updated</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map(service => `
                <tr>
                  <td>
                    <div style="font-weight: 600;">${service.name}</div>
                  </td>
                  <td>
                    <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                      ${service.description || '-'}
                    </div>
                  </td>
                  <td>
                    <span class="badge badge-${getStatusBadgeClass(service.status)}">
                      ${Utils.translateStatus(service.status)}
                    </span>
                  </td>
                  <td>${Utils.formatRelativeTime(service.updated_at)}</td>
                  <td>
                    <button
                      class="btn btn-sm btn-secondary"
                      onclick="viewService(${service.id})"
                    >
                      View Details
                    </button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderIncidents() {
        const container = document.getElementById('incidentsContainer');
        const statusFilter = document.getElementById('incidentStatusFilter').value;
        const severityFilter = document.getElementById('incidentSeverityFilter').value;

        let filtered = incidents;
        if (statusFilter) {
            filtered = filtered.filter(i => i.status === statusFilter);
        }
        if (severityFilter) {
            filtered = filtered.filter(i => i.severity === severityFilter);
        }

        // Sort by date (newest first)
        filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        // Limit to 10 most recent
        filtered = filtered.slice(0, 10);

        if (filtered.length === 0) {
            container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ‰</div>
            <div class="empty-state-text">No incidents</div>
            <div class="empty-state-subtext">All systems running smoothly</div>
          </div>
        `;
            return;
        }

        container.innerHTML = `
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Incident</th>
                <th>Service</th>
                <th>Severity</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${filtered.map(incident => {
            const service = services.find(s => s.id === incident.service_id);
            return `
                  <tr>
                    <td>
                      <div style="font-weight: 600;">${incident.title}</div>
                      <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        ${incident.description.substring(0, 80)}${incident.description.length > 80 ? '...' : ''}
                      </div>
                    </td>
                    <td>${service ? service.name : 'Unknown'}</td>
                    <td>
                      <span class="badge badge-${getSeverityBadgeClass(incident.severity)}">
                        ${Utils.translateStatus(incident.severity)}
                      </span>
                    </td>
                    <td>
                      <span class="badge badge-${getStatusBadgeClass(incident.status)}">
                        ${Utils.translateStatus(incident.status)}
                      </span>
                    </td>
                    <td>${Utils.formatRelativeTime(incident.created_at)}</td>
                    <td>
                      <button
                        class="btn btn-sm btn-secondary"
                        onclick="window.location.href='incident-detail.html?id=${incident.id}'"
                      >
                        View Details
                      </button>
                    </td>
                  </tr>
                `;
        }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function viewService(id) {
        window.location.href = `service-detail.html?id=${id}`;
    }

    function viewIncident(id) {
        window.location.href = `incident-detail.html?id=${id}`;
    }

    function getStatusBadgeClass(status) {
        const classes = {
            'up': 'success',
            'degraded': 'warning',
            'down': 'danger',
            'open': 'warning',
            'resolved': 'success'
        };
        return classes[status] || 'info';
    }

    function getSeverityBadgeClass(severity) {
        const classes = {
            'low': 'info',
            'medium': 'warning',
            'high': 'danger',
            'critical': 'danger'
        };
        return classes[severity] || 'info';
    }
</script>
<script>
    // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
    async function openReportModal() {
        const modal = document.getElementById('reportIncidentModal');
        const serviceSelect = document.getElementById('new-incident-service');

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
        document.getElementById('reportIncidentForm').reset();

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§
        try {
            const result = await API.getServices();
            const services = result.data?.services || [];

            // serviceSelect.innerHTML = '<option value="">ÛŒÚ© Ø³Ø±ÙˆÛŒØ³ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>';
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = service.name;
                serviceSelect.appendChild(option);
            });
        } catch (error) {
            // console.error('Error loading services:', error);
            // alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§');
        }

        modal.style.display = 'block';
    }

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
    function closeReportModal() {
        document.getElementById('reportIncidentModal').style.display = 'none';
    }

    // Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø®Ø¯Ø§Ø¯ Ø¬Ø¯ÛŒØ¯
    async function handleCreateIncident(event) {
        event.preventDefault();

        const submitBtn = event.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯...';

        const incidentData = {
            service_id: parseInt(document.getElementById('new-incident-service').value),
            title: document.getElementById('new-incident-title').value.trim(),
            description: document.getElementById('new-incident-description').value.trim(),
            severity: document.getElementById('new-incident-severity').value,
            is_published: document.getElementById('new-incident-published').checked
        };

        try {
            const result = await API.createIncident(incidentData);

            if (result.success) {
                alert('âœ… Ø±Ø®Ø¯Ø§Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!');
                closeReportModal();

                // Ø±ÙØ±Ø´ Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡
                await loadIncidents();
                await loadStats();
            } else {
                alert('âŒ Ø®Ø·Ø§: ' + (result.message || 'Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø®Ø¯Ø§Ø¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯'));
            }
        } catch (error) {
            console.error('Error creating incident:', error);
            alert('âŒ Ø®Ø·Ø§: ' + (error.message || 'Ø§ÛŒØ¬Ø§Ø¯ Ø±Ø®Ø¯Ø§Ø¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯'));
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }

    // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('reportIncidentModal');
        if (event.target === modal) {
            closeReportModal();
        }
    });
</script>
</body>
</html>
