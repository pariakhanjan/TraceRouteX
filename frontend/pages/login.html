<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | TracerouteX</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .login-container {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 420px;
            padding: 2.5rem;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .login-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .login-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .login-footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }

        .demo-credentials {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .demo-credentials-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .demo-credential-item {
            margin: 0.25rem 0;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
<div class="login-container">
    <div class="login-header">
        <div class="login-logo">üõ∞Ô∏è</div>
        <h1 class="login-title">Welcome Back</h1>
        <p class="login-subtitle">Sign in to TracerouteX Dashboard</p>
    </div>

    <!-- Demo Credentials Info -->
    <div class="demo-credentials">
        <div class="demo-credentials-title">Demo Accounts:</div>
        <div class="demo-credential-item">üëë Admin: admin@traceroutex.com</div>
        <div class="demo-credential-item">üîß Engineer: engineer@traceroutex.com</div>
        <div class="demo-credential-item">üëÅÔ∏è Viewer: viewer@traceroutex.com</div>
        <div class="demo-credential-item" style="margin-top: 0.5rem;">üîë Password: password123</div>
    </div>

    <form id="loginForm">
        <div class="form-group">
            <label class="form-label" for="email">Email Address</label>
            <input
                    type="email"
                    id="email"
                    name="email"
                    class="form-input"
                    placeholder="your.email@example.com"
                    required
                    autocomplete="email"
            >
        </div>

        <div class="form-group">
            <label class="form-label" for="password">Password</label>
            <input
                    type="password"
                    id="password"
                    name="password"
                    class="form-input"
                    placeholder="Enter your password"
                    required
                    autocomplete="current-password"
            >
        </div>

        <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
            <span>üîê</span> Sign In
        </button>
    </form>

    <div class="login-footer">
        Don't have an account?
        <a href="register.html">Register now</a>
    </div>

    <div class="login-footer" style="margin-top: 1rem;">
        <a href="../index.html">‚Üê Back to Home</a>
    </div>
</div>

<script src="../assets/js/utils.js"></script>
<script src="../assets/js/api.js"></script>
<script src="../assets/js/auth.js"></script>
<script>
    // Redirect if already logged in
    if (Auth.isLoggedIn()) {
        window.location.href = 'dashboard.html';
    }
// =========================================
    // LOGIN HANDLER - COMPLETE FIX
    // =========================================
    
    document.addEventListener('DOMContentLoaded', () => {
      const loginForm = document.getElementById('loginForm');
      
      if (!loginForm) {
        console.error('‚ùå Login form not found!');
        return;
      }

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        console.log('üîê Login form submitted');
        
        // ÿØÿ±€åÿßŸÅÿ™ ŸÖŸÇÿßÿØ€åÿ± ŸÅÿ±ŸÖ
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        
        if (!emailInput || !passwordInput) {
          console.error('‚ùå Form inputs not found');
          Utils.showAlert('Form error: inputs not found', 'error');
          return;
        }
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;
        
        console.log('üìß Attempting login for:', email);
        
        // ÿßÿπÿ™ÿ®ÿßÿ±ÿ≥ŸÜÿ¨€å
        if (!email || !password) {
          Utils.showAlert('Please enter email and password', 'error');
          return;
        }
        
        try {
          Utils.showLoading();
          
          console.log('üåê Calling API.login...');
          
          // ŸÅÿ±ÿßÿÆŸàÿßŸÜ€å API
          const result = await API.login({ 
            email,
            password 
          });
          
          console.log('üì¶ API Response:', result);
          console.log('  - success:', result.success);
          console.log('  - data:', result.data);
          
          // ‚úÖ ÿ®ÿ±ÿ±ÿ≥€å response
          if (result.success && result.data) {
            const token = result.data.token;
            const user  = result.data.user;
            
            console.log('üé´ Token:', token ? '‚úì received' : '‚úó missing');
            console.log('üë§ User:', user ? '‚úì received' : '‚úó missing');
            
            if (!token) {
              throw new Error('No token received from server');
            }
            
            if (!user) {
              throw new Error('No user data received from server');
            }
            
            // ‚úÖ ÿ∞ÿÆ€åÿ±Ÿá‚Äåÿ≥ÿßÿ≤€å ÿµÿ≠€åÿ≠
            console.log('üíæ Saving auth data...');
            console.log('  - Token length:', token.length);
            console.log('  - User object:', JSON.stringify(user));

            try {
              Auth.saveAuth(token, user);
            } catch (saveError) {
              console.error('‚ùå Failed to save auth:', saveError);
              throw new Error('Failed to save authentication data');
            }
            
            // ‚úÖ ÿ®ÿ±ÿ±ÿ≥€å ÿ∞ÿÆ€åÿ±Ÿá‚Äåÿ≥ÿßÿ≤€å
            const savedToken = localStorage.getItem('token');
            const savedUser = localStorage.getItem('user');
            
            console.log('üíæ Verification:');
            console.log('  - Token saved:', savedToken ? '‚úì YES' : '‚úó NO');
            console.log('  - Token value:', savedToken ? savedToken.substring(0, 30) + '...' : 'NULL');
            console.log('  - User saved:', savedUser ? '‚úì YES' : '‚úó NO');
            console.log('  - User value:', savedUser);
            
            if (!savedToken) {
              throw new Error('Token was not saved to localStorage');
            }
            
            if (!savedUser) {
              throw new Error('User was not saved to localStorage');
            }

            let parsedUser;
            try {
              parsedUser = JSON.parse(savedUser);
              console.log('  - User parsed:', parsedUser);
              console.log('  - User role:', parsedUser.role);
            } catch (parseError) {
              console.error('‚ùå User cannot be parsed:', parseError);
              throw new Error('User data is corrupted');
            }
            
            // ŸÜŸÖÿß€åÿ¥ Ÿæ€åÿßŸÖ ŸÖŸàŸÅŸÇ€åÿ™
            Utils.showAlert(result.message || 'Login successful!', 'success');
            
            console.log('üîÑ Redirecting to dashboard in 800ms...');
            
            // ‚úÖ FIX: Redirect ÿ®ÿß ÿ™ÿßÿÆ€åÿ± ⁄©Ÿàÿ™ÿßŸá ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ Ÿæ€åÿßŸÖ
            setTimeout(() => {
              console.log('üéØ Executing redirect NOW');
              window.location.href = '/pages/dashboard.html';
            }, 800);
            
          } else {
            console.error('‚ùå Login failed:', result.message);
            throw new Error(result.message || 'Login failed');
          }
          
        } catch (error) {
          console.error('üí• Login error:', error);
          console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            name: error.name
          });
          
          Utils.showAlert(
            error.message || 'Login failed. Please try again.', 
            'error'
          );
        } finally {
          Utils.hideLoading();
        }
      });
      
      console.log('‚úÖ Login handler initialized');
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (!Utils.validateEmail(email)) {
            Utils.showAlert('Please enter a valid email address', 'error');
            return;
        }

        if (!password) {
            Utils.showAlert('Please enter your password', 'error');
            return;
        }

        const loginBtn = document.getElementById('loginBtn');
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<span>‚è≥</span> Signing in...';

        try {
            const response = await API.login({ email, password });

            // Save auth data
            Auth.saveAuth(response.data.user, response.data.token);

            Utils.showAlert('Login successful! Redirecting...', 'success');

            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1000);

        } catch (error) {
            Utils.showAlert(error.message, 'error');
            loginBtn.disabled = false;
            loginBtn.innerHTML = '<span>üîê</span> Sign In';
        }
    });
</script>
</body>
</html>
