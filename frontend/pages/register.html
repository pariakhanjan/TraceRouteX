<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register | TracerouteX</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .register-container {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
        }

        .register-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .register-logo {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .register-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .register-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .register-footer {
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .register-footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .register-footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="register-container">
    <div class="register-header">
        <div class="register-logo">üõ∞Ô∏è</div>
        <h1 class="register-title">Create Account</h1>
        <p class="register-subtitle">Join TracerouteX monitoring system</p>
    </div>

    <form id="registerForm">
        <div class="form-group">
            <label class="form-label" for="username">Username *</label>
            <input
                    type="text"
                    id="username"
                    name="username"
                    class="form-input"
                    placeholder="Enter your username"
                    required
                    minlength="3"
                    maxlength="50"
            >
            <small class="form-hint">3-50 characters, alphanumeric and underscores only</small>
        </div>

        <div class="form-group">
            <label class="form-label" for="email">Email Address *</label>
            <input
                    type="email"
                    id="email"
                    name="email"
                    class="form-input"
                    placeholder="your.email@example.com"
                    required
            >
        </div>

        <div class="form-group">
            <label class="form-label" for="password">Password *</label>
            <input
                    type="password"
                    id="password"
                    name="password"
                    class="form-input"
                    placeholder="Enter strong password"
                    required
                    minlength="8"
            >
            <small class="form-hint">Minimum 8 characters</small>
        </div>

        <div class="form-group">
            <label class="form-label" for="confirmPassword">Confirm Password *</label>
            <input
                    type="password"
                    id="confirmPassword"
                    name="confirmPassword"
                    class="form-input"
                    placeholder="Re-enter your password"
                    required
            >
        </div>

        <button type="submit" class="btn btn-primary btn-block" id="registerBtn">
            <span>‚ú®</span> Create Account
        </button>
    </form>

    <div class="register-footer">
        Already have an account?
        <a href="login.html">Login here</a>
    </div>
</div>

<script src="../assets/js/utils.js"></script>
<script src="../assets/js/api.js"></script>
<script src="../assets/js/auth.js"></script>
<script>
    // Redirect if already logged in
    if (Auth.isLoggedIn()) {
        window.location.href = 'dashboard.html';
    }

    document.addEventListener('DOMContentLoaded', () => {
  const registerForm = document.getElementById('registerForm');
  
  if (registerForm) {
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // ÿØÿ±€åÿßŸÅÿ™ ŸÖŸÇÿßÿØ€åÿ± ŸÅÿ±ŸÖ
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      
      // ÿßÿπÿ™ÿ®ÿßÿ±ÿ≥ŸÜÿ¨€å
      if (!username || !password || !fullName || !email) {
        Utils.showAlert('Please fill all fields', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        Utils.showAlert('Passwords do not match', 'error');
        return;
      }
      
      if (password.length < 6) {
        Utils.showAlert('Password must be at least 6 characters', 'error');
        return;
      }
      
      try {
        Utils.showLoading();
        
        // ŸÅÿ±ÿßÿÆŸàÿßŸÜ€å API
        const result = await API.register({
          username,
          password,
          full_name: fullName,
          email
        });
        
        console.log('Register response:', result);
        
        // ‚úÖ FIX: ÿ∞ÿÆ€åÿ±Ÿá‚Äåÿ≥ÿßÿ≤€å ÿµÿ≠€åÿ≠ token Ÿà user
        if (result.success && result.data) {
          const { token, user } = result.data;
          
          if (!token || !user) {
            throw new Error('Invalid response: missing token or user');
          }
          
          // ‚úÖ ÿ∞ÿÆ€åÿ±Ÿá ÿµÿ≠€åÿ≠
          Auth.saveAuth(token, user);
          
          Utils.showAlert(result.message || 'Registration successful!', 'success');
          
          // ŸáÿØÿß€åÿ™ ÿ®Ÿá ÿØÿßÿ¥ÿ®Ÿàÿ±ÿØ
          setTimeout(() => {
            window.location.href = '/pages/dashboard.html';
          }, 1000);
          
        } else {
          throw new Error(result.message || 'Registration failed');
        }
        
      } catch (error) {
        console.error('Registration error:', error);
        Utils.showAlert(error.message || 'Registration failed. Please try again.', 'error');
      } finally {
        Utils.hideLoading();
      }
    });
  }
});

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        // Client-side validation
        if (!Utils.validateEmail(email)) {
            Utils.showAlert('Please enter a valid email address', 'error');
            return;
        }

        if (!Utils.validatePassword(password)) {
            Utils.showAlert('Password must be at least 8 characters', 'error');
            return;
        }

        if (password !== confirmPassword) {
            Utils.showAlert('Passwords do not match', 'error');
            return;
        }

        // Username validation
        if (!/^[a-zA-Z0-9_]{3,50}$/.test(username)) {
            Utils.showAlert('Username must be 3-50 characters and contain only letters, numbers, and underscores', 'error');
            return;
        }

        const registerBtn = document.getElementById('registerBtn');
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<span>‚è≥</span> Creating account...';

        try {
            const response = await API.register({
                username,
                email,
                password
            });

            // Save auth data
            Auth.saveAuth(response.data.user, response.data.token);

            Utils.showAlert('Registration successful! Redirecting...', 'success');

            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1500);

        } catch (error) {
            Utils.showAlert(error.message, 'error');
            registerBtn.disabled = false;
            registerBtn.innerHTML = '<span>‚ú®</span> Create Account';
        }
    });
</script>
</body>
</html>