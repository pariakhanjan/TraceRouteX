<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Details | TracerouteX</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <style>
        .service-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .service-title-section {
            flex: 1;
        }

        .service-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .service-description-display {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .service-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .service-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .service-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .info-card-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .info-card-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .incidents-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline-item {
            position: relative;
            padding-bottom: 2rem;
            border-left: 2px solid var(--border-color);
            padding-left: 2rem;
        }

        .timeline-item:last-child {
            border-left-color: transparent;
            padding-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: -9px;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary-color);
        }

        .timeline-dot.success {
            border-color: var(--success-color);
        }

        .timeline-dot.warning {
            border-color: var(--warning-color);
        }

        .timeline-dot.danger {
            border-color: var(--danger-color);
        }

        .timeline-content {
            background: white;
            padding: 1rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .timeline-content:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 1rem;
        }

        .timeline-title {
            font-weight: 600;
            color: var(--text-primary);
        }

        .timeline-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .timeline-description {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .back-button:hover {
            text-decoration: underline;
        }

        #serviceForm {
            display: none;
        }

        #serviceForm.active {
            display: block;
        }

        #serviceDisplay {
            display: block;
        }

        #serviceDisplay.hidden {
            display: none;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.875rem;
        }

        .status-indicator.status-up {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-indicator.status-degraded {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-indicator.status-down {
            background-color: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar">
    <div class="navbar-container">
        <div class="navbar-brand">
            <span class="navbar-logo">üõ∞Ô∏è</span>
            <span class="navbar-title">TracerouteX</span>
        </div>

        <div class="navbar-menu">
            <a href="dashboard.html" class="navbar-link">
                <span>üìä</span> Dashboard
            </a>
            <a href="public-status.html" class="navbar-link">
                <span>üåê</span> Status Page
            </a>
            <div class="navbar-divider"></div>
            <div class="navbar-user">
                <span class="user-info"></span>
                <span class="user-role badge"></span>
            </div>
            <button id="logoutBtn" class="btn btn-secondary btn-sm">
                Logout
            </button>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="main-content">
    <div class="container">
        <a href="dashboard.html" class="back-button">
            <span>‚Üê</span> Back to Dashboard
        </a>

        <!-- Service Display (View Mode) -->
        <div id="serviceDisplay">
            <div class="service-detail-header">
                <div class="service-title-section">
                    <h1 class="service-title">
                        <span id="serviceName">Loading...</span>
                        <span id="serviceStatusBadge"></span>
                    </h1>
                    <div class="service-description-display" id="serviceDescription"></div>
                    <div class="service-meta">
                        <div class="service-meta-item">
                            <span>üìÖ</span>
                            <span>Created: <strong id="serviceCreatedAt">-</strong></span>
                        </div>
                        <div class="service-meta-item">
                            <span>üîÑ</span>
                            <span>Last Updated: <strong id="serviceUpdatedAt">-</strong></span>
                        </div>
                    </div>
                </div>

                <div class="service-actions" id="adminServiceActions" style="display: none;">
                    <button class="btn btn-primary" id="editServiceBtn">
                        <span>‚úèÔ∏è</span> Edit Service
                    </button>
                    <button class="btn btn-danger" id="deleteServiceBtn">
                        <span>üóëÔ∏è</span> Delete Service
                    </button>
                </div>
            </div>

            <!-- Service Info -->
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-card-label">Current Status</div>
                    <div class="info-card-value">
                        <span id="currentStatusDisplay" class="status-indicator">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <div class="info-card-label">Active Incidents</div>
                    <div class="info-card-value" id="activeIncidentsCount">-</div>
                </div>

                <div class="info-card">
                    <div class="info-card-label">Total Incidents</div>
                    <div class="info-card-value" id="totalIncidentsCount">-</div>
                </div>
            </div>

            <!-- Related Incidents -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Incident History</h2>
                    <button class="btn btn-primary btn-sm" id="addIncidentBtn" style="display: none;">
                        <span>‚ûï</span> Report Incident
                    </button>
                </div>

                <div id="incidentsContainer">
                    <!-- Incidents timeline will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Service Form (Edit/Create Mode) -->
        <div id="serviceForm">
            <div class="card">
                <h2 class="card-title" id="formTitle">Create New Service</h2>

                <form id="serviceFormElement">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="name">Service Name *</label>
                            <input
                                    type="text"
                                    id="name"
                                    name="name"
                                    class="form-input"
                                    placeholder="e.g., Payment Service"
                                    required
                                    minlength="3"
                                    maxlength="100"
                            >
                            <small class="form-hint">Maximum 100 characters</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="status">Status *</label>
                            <select id="status" name="status" class="form-select" required>
                                <option value="up">‚úÖ Operational (Up)</option>
                                <option value="degraded">‚ö†Ô∏è Degraded Performance</option>
                                <option value="down">üî¥ Down</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="description">Description *</label>
                        <textarea
                                id="description"
                                name="description"
                                class="form-textarea"
                                placeholder="Describe the service and its purpose..."
                                required
                                rows="4"
                        ></textarea>
                        <small class="form-hint">Provide a clear description of what this service does</small>
                    </div>

                    <div class="service-actions">
                        <button type="submit" class="btn btn-primary">
                            <span>üíæ</span> Save Service
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelFormBtn">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<script src="../assets/js/utils.js"></script>
<script src="../assets/js/api.js"></script>
<script src="../assets/js/auth.js"></script>
<script>
    // Check authentication
    if (!Auth.requireAuth()) {
        // Redirects to login if not authenticated
    }

    let currentServiceId = null;
    let currentService = null;
    let isEditMode = false;
    let isCreateMode = false;

    document.addEventListener('DOMContentLoaded', async () => {
        const user = Auth.getUser();
        Auth.displayUserInfo();

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const action = urlParams.get('action');
        const serviceId = urlParams.get('id');

        // Determine mode
        if (action === 'create') {
            if (!Auth.hasRole('admin')) {
                Utils.showAlert('Only admins can create services', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
                return;
            }
            isCreateMode = true;
            showForm();
        } else if (serviceId) {
            currentServiceId = parseInt(serviceId);
            await loadServiceDetails(currentServiceId);
        } else {
            Utils.showAlert('Invalid service', 'error');
            setTimeout(() => window.location.href = 'dashboard.html', 2000);
        }

        // Show admin controls (only admin can edit/delete services)
        if (Auth.hasRole('admin')) {
            document.getElementById('adminServiceActions').style.display = 'flex';
        }

        // Show add incident button for engineers and admins
        if (Auth.hasRole('engineer', 'admin')) {
            document.getElementById('addIncidentBtn').style.display = 'inline-flex';
        }

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await API.logout();
                Auth.logout();
            } catch (error) {
                Auth.logout();
            }
        });

        // Edit button
        document.getElementById('editServiceBtn')?.addEventListener('click', () => {
            isEditMode = true;
            showForm();
            populateForm();
        });

        // Delete button
        document.getElementById('deleteServiceBtn')?.addEventListener('click', async () => {
            if (confirm('Are you sure you want to delete this service? This will also delete all related incidents. This action cannot be undone.')) {
                await deleteService();
            }
        });

        // Cancel form button
        document.getElementById('cancelFormBtn').addEventListener('click', () => {
            if (isCreateMode) {
                window.location.href = 'dashboard.html';
            } else {
                isEditMode = false;
                showDisplay();
            }
        });

        // Form submit
        document.getElementById('serviceFormElement').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveService();
        });

        // Add incident button
        document.getElementById('addIncidentBtn')?.addEventListener('click', () => {
            window.location.href = `incident-detail.html?action=create&service_id=${currentServiceId}`;
        });
    });

    function displayServiceDetails(service) {
        const titleEl = document.getElementById('serviceTitle');
        if (titleEl) {
            titleEl.textContent = service.name || 'Unknown Service';
        }

        const createdEl = document.getElementById('serviceCreatedAt');
        if (createdEl) {
            createdEl.textContent = service.created_at ? Utils.formatPersianDate(service.created_at) : '-';
        }

        const updatedEl = document.getElementById('serviceUpdatedAt');
        if (updatedEl) {
            updatedEl.textContent = service.updated_at ? Utils.formatPersianDate(service.updated_at) : '-';
        }

        const descEl = document.getElementById('serviceDescription');
        if (descEl) {
            descEl.textContent = service.description || 'No description';
        }

        const statusEl = document.getElementById('currentStatus');
        if (statusEl) {
            const statusConfig = getStatusConfig(service.status);
            statusEl.innerHTML = `<span class="status-badge status-${service.status}">${statusConfig.icon} ${statusConfig.text}</span>`;
        }

        updateStats(service);
    }

    async function loadServiceDetails() {
        try {
            const response = await API.getServiceById(currentServiceId);
        
            if (!response || !response.success) {
                throw new Error(response?.message || 'Failed to load service');
            }

            const serviceData = response.data;  // ‚ö†Ô∏è ÿ≠ÿ∞ŸÅ ⁄©ÿ±ÿØŸÖ: .service || response.data
        
            if (!serviceData) {
                throw new Error('Service data not found');
            }

            currentService = serviceData;
            displayServiceDetails(serviceData);
            loadServiceIncidents();

        } catch (error) {
            console.error('Error:', error);
            Utils.showAlert('Error: ' + error.message, 'error');
            setTimeout(() => window.location.href = '/pages/dashboard.html', 3000);
        }
    }

    function updateStats(service) {
        const activeEl = document.getElementById('activeIncidents');
        const totalEl = document.getElementById('totalIncidents');
    
        if (activeEl) activeEl.textContent = '0';
        if (totalEl) totalEl.textContent = '0';
    }

    function updateIncidentStats(incidents) {
        if (!incidents) return;

        const activeIncidents = incidents.filter(i => 
            i.status === 'investigating' || i.status === 'identified' || i.status === 'monitoring'
        ).length;

        const activeEl = document.getElementById('activeIncidents');
        const totalEl = document.getElementById('totalIncidents');
    
        if (activeEl) activeEl.textContent = activeIncidents;
        if (totalEl) totalEl.textContent = incidents.length;
    }

    async function loadServiceIncidents(serviceId) {
        try {
            const response = await API.getIncidents({ service_id: serviceId });
            const incidents = response.data.incidents;

            const container = document.getElementById('incidentsContainer');

            // Update incident counts
            const activeCount = incidents.filter(i => i.status === 'open').length;
            document.getElementById('activeIncidentsCount').textContent = activeCount;
            document.getElementById('totalIncidentsCount').textContent = incidents.length;

            if (incidents.length === 0) {
                container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üéâ</div>
              <div class="empty-state-text">No incidents reported</div>
              <div class="empty-state-subtext">This service has been running smoothly</div>
            </div>
          `;
                return;
            }

            // Sort by date (newest first)
            incidents.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            container.innerHTML = `
          <div class="incidents-timeline">
            ${incidents.map(incident => `
              <div class="timeline-item">
                <div class="timeline-dot ${getSeverityDotClass(incident.severity)}"></div>
                <div class="timeline-content" onclick="window.location.href='incident-detail.html?id=${incident.id}'">
                  <div class="timeline-header">
                    <div class="timeline-title">${incident.title}</div>
                    <div class="timeline-time">${Utils.formatRelativeTime(incident.created_at)}</div>
                  </div>
                  <div style="margin-bottom: 0.5rem;">
                    <span class="badge badge-${getSeverityBadgeClass(incident.severity)}">
                      ${Utils.translateStatus(incident.severity)}
                    </span>
                    <span class="badge badge-${getStatusBadgeClass(incident.status)}">
                      ${Utils.translateStatus(incident.status)}
                    </span>
                    ${incident.is_published ? '<span class="badge badge-info">Published</span>' : ''}
                  </div>
                  <div class="timeline-description">${Utils.truncate(incident.description, 120)}</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;

        } catch (error) {
            console.error('Error loading incidents:', error);
            document.getElementById('activeIncidentsCount').textContent = '0';
            document.getElementById('totalIncidentsCount').textContent = '0';
        }
    }

    function showForm() {
        document.getElementById('serviceDisplay').classList.add('hidden');
        document.getElementById('serviceForm').classList.add('active');
        document.getElementById('formTitle').textContent = isCreateMode ? 'Create New Service' : 'Edit Service';
    }

    function showDisplay() {
        document.getElementById('serviceForm').classList.remove('active');
        document.getElementById('serviceDisplay').classList.remove('hidden');
    }

    function populateForm() {
        if (!currentService) return;

        document.getElementById('name').value = currentService.name;
        document.getElementById('description').value = currentService.description || '';
        document.getElementById('status').value = currentService.status;
    }

    async function saveService() {
        const formData = {
            name: document.getElementById('name').value.trim(),
            description: document.getElementById('description').value.trim(),
            status: document.getElementById('status').value
        };

        // Validation
        if (!formData.name || formData.name.length < 3) {
            Utils.showAlert('Service name must be at least 3 characters', 'error');
            return;
        }

        if (!formData.description) {
            Utils.showAlert('Please provide a service description', 'error');
            return;
        }

        const submitBtn = document.querySelector('#serviceFormElement button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>‚è≥</span> Saving...';

        try {
            if (isCreateMode) {
                const response = await API.createService(formData);
                Utils.showAlert('Service created successfully!', 'success');
                setTimeout(() => {
                    window.location.href = `service-detail.html?id=${response.data.service.id}`;
                }, 1500);
            } else {
                await API.updateService(currentServiceId, formData);
                Utils.showAlert('Service updated successfully!', 'success');
                isEditMode = false;
                await loadServiceDetails(currentServiceId);
                showDisplay();
            }
        } catch (error) {
            Utils.showAlert('Error saving service: ' + error.message, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>üíæ</span> Save Service';
        }
    }

    async function deleteService() {
        try {
            await API.deleteService(currentServiceId);
            Utils.showAlert('Service deleted successfully!', 'success');
            setTimeout(() => {
                window.location.href = 'dashboard.html';
            }, 1500);
        } catch (error) {
            Utils.showAlert('Error deleting service: ' + error.message, 'error');
        }
    }

    function getStatusBadgeClass(status) {
        const classes = {
            'up': 'success',
            'degraded': 'warning',
            'down': 'danger',
            'open': 'warning',
            'resolved': 'success'
        };
        return classes[status] || 'info';
    }

    function getSeverityBadgeClass(severity) {
        const classes = {
            'low': 'info',
            'medium': 'warning',
            'high': 'danger',
            'critical': 'danger'
        };
        return classes[severity] || 'info';
    }

    function getSeverityDotClass(severity) {
        const classes = {
            'low': 'success',
            'medium': 'warning',
            'high': 'danger',
            'critical': 'danger'
        };
        return classes[severity] || '';
    }
</script>
</body>
</html>
